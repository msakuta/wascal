<html>
    <head>
        <style type="text/css">
            body {
                color: #000000;
                text-align:center;

                background-color: #f0f0f0;
                margin: 0px;
                width: 100%;
            }
            .code {
                font-family:Monospace;
                font-size:15px;
            }
            .justify {
                text-align: justify;
                padding: 2em;
            }
        </style>
        <script>

let obj;
let argElems = [];

window.addEventListener("load", () => {
    const consoleElem = document.getElementById("console");

    const opts = {
        Math: {
            abs: x => Math.abs(x),
        },
        console: {
            log: console.log,
        },
        output: {
            putc: c => {
                consoleElem.innerHTML += String.fromCharCode(c);
            }
        }
    };

    const load = document.getElementById("load");
    load.addEventListener("click", async () => {
        console.log("Loading wasm");
        obj = await WebAssembly.instantiateStreaming(fetch("wascal.wasm"), opts);

        const params = document.getElementById("params");
        while (params.firstChild) params.removeChild(params.firstChild);
        argElems = [];

        if (!obj.instance.exports.hello) {
            const errorElem = document.createElement("div");
            errorElem.innerHTML = "Compiled Wasm module does not have function 'hello'";
            params.appendChild(errorElem);
            return;
        }

        for (let i = 0; i < obj.instance.exports.hello.length; i++) {
            const label = document.createElement("label");
            const input = document.createElement("input");
            input.setAttribute("type", "text");
            input.value = 1;
            label.appendChild(input);
            params.appendChild(label);
            argElems.push(input);
        }
    });
    const call = document.getElementById("call");
    call.addEventListener("click", async () => {
        console.log("Calling wasm");
        let args = [];
        for (let i = 0; i < obj.instance.exports.hello.length; i++) {
            const x = parseFloat(argElems[i].value);
            args.push(x);
        }
        const output = document.getElementById('output');
        const hello = obj.instance.exports.hello;
        const start = performance.now();
        try{
            output.innerHTML = hello.apply(this, args);
        }
        catch(e){
            consoleElem.value = e;
        }
        const end = performance.now();
        document.getElementById("timeMessage").innerHTML = `Execution time: ${(end - start).toFixed(1)} ms (See <a href="#Time">notes</a>)`;
    });
});

        </script>
    </head>
    <body>
        <h1>Wascal</h1>
        <button id="load">Load wasm module</button>
        <div id="params"></div>
        <p>
            Output: <span id="output"></span>
        </p>
        <button id="call">Call</button>
        <div id="timeMessage"></div>
        <div class="code">
            <textarea  id="console" type="text" readonly cols="120"  rows="20" ></textarea>
        </div>

        <div class="justify">
            <h2 id="Time">Time measurement resolution</h2>
            Due to security reasons, your browser may have reduced time resolution for measurement.
            It is typically 0.1ms or 1ms, but can be larger.
            Please be aware that the lower digits may be always 0 because of this rounding.
            See <a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/now#reduced_time_precision">this page</a> for details.
        </div>
    </body>
</html>